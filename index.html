<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SmartWorkSense Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: #111;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #6ab7ff;
        }

        .btn-teste {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #6ab7ff;
            color: #111;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1000;
        }

        .btn-teste:hover {
            background: #5aa6ef;
        }

        .cards {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }

        .card {
            background: #1b1b1b;
            padding: 15px;
            width: 22%;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #333;
        }

        .card h2 {
            font-size: 18px;
            margin: 0 0 10px 0;
        }

        .card p {
            font-size: 24px;
            margin: 5px 0;
            font-weight: bold;
        }

        .alerta {
            font-size: 16px;
            margin-top: 8px;
            font-weight: bold;
        }

        .grafico-box {
            width: 30%;
            background: #1b1b1b;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
        }

        .graficos-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin: 40px 20px;
        }

        .linha-horizontal {
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #6ab7ff, transparent);
            margin: 30px 0;
        }

        canvas {
            background: #111;
            padding: 10px;
            border-radius: 10px;
            max-height: 250px;
        }

        .cadeira-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 250px;
            position: relative;
        }

        .cadeira {
            width: 200px;
            height: 220px;
            position: relative;
            transition: transform 0.5s ease;
            transform-origin: 50% 80%;
        }

        /* Encosto - vertical visto de lado */
        .encosto {
            width: 15px;
            height: 130px;
            background: linear-gradient(to right, #666, #333);
            border-radius: 12px;
            position: absolute;
            bottom: 70px;
            left: 30px;
            border: 3px solid #888;
            box-shadow: -3px 0 8px rgba(0,0,0,0.6);
        }

        /* Assento - horizontal visto de lado */
        .assento {
            width: 100px;
            height: 15px;
            background: linear-gradient(to bottom, #777, #444);
            border-radius: 10px;
            position: absolute;
            bottom: 70px;
            left: 30px;
            border: 3px solid #888;
            box-shadow: 0 3px 8px rgba(0,0,0,0.6);
        }

        /* Pernas dianteiras e traseiras */
        .perna {
            width: 12px;
            height: 70px;
            background: linear-gradient(to right, #555, #222);
            position: absolute;
            bottom: 0;
            border-radius: 6px;
            border: 2px solid #666;
        }

        .perna-esquerda { left: 40px; }
        .perna-direita { left: 110px; }
        
        /* Base da cadeira */
        .base-rodas {
            width: 80px;
            height: 8px;
            background: #444;
            border-radius: 4px;
            position: absolute;
            bottom: 0;
            left: 50px;
        }

        .angulo-texto {
            font-size: 28px;
            font-weight: bold;
            color: #6ab7ff;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<button class="btn-teste" onclick="testarInclinacao()">üß™ Testar Inclina√ß√£o</button>

<h1>üìä SmartWorkSense ‚Äì Monitoramento em Tempo Real</h1>

<div class="cards">
    <div class="card">
        <h2>üå° Temperatura</h2>
        <p id="temp">--</p>
    </div>

    <div class="card">
        <h2>üí° Luminosidade</h2>
        <p id="lux">--</p>
    </div>

    <div class="card">
        <h2>üßç Postura</h2>
        <p id="postura">--</p>
        <p class="alerta" id="alertaTexto">--</p>
    </div>

    <div class="card">
        <h2>üìê Inclina√ß√£o</h2>
        <p id="inclinacao">--¬∞</p>
    </div>
</div>

<div class="linha-horizontal"></div>

<!-- ============================= -->
<!--       GR√ÅFICOS REAIS         -->
<!-- ============================= -->

<div class="graficos-container">
    <div class="grafico-box">
        <h3 style="text-align: center; margin-top: 0;">üìà Temperatura</h3>
        <canvas id="grafTemp"></canvas>
    </div>

    <div class="grafico-box">
        <h3 style="text-align: center; margin-top: 0;">üí° Luminosidade</h3>
        <canvas id="grafLux"></canvas>
    </div>

    <div class="grafico-box">
        <h3 style="text-align: center; margin-top: 0;">ü™ë Inclina√ß√£o da Cadeira</h3>
        <div class="cadeira-container">
            <div class="cadeira" id="cadeiraVisual">
                <div class="encosto"></div>
                <div class="assento"></div>
                <div class="perna perna-esquerda"></div>
                <div class="perna perna-direita"></div>
                <div class="base-rodas"></div>
            </div>
            <div class="angulo-texto" id="anguloTexto">0¬∞</div>
        </div>
    </div>
</div>

<script>
    // Conecta ao servidor Flask
    const socket = io('http://localhost:5000');

    // Log de conex√£o
    socket.on('connect', () => {
        console.log('‚úì Conectado ao servidor!');
        // Ao conectar, aguardamos dados; se n√£o chegarem, o fallback cuidar√°
    });

    socket.on('disconnect', () => {
        console.log('‚úó Desconectado do servidor!');
        // Em caso de desconex√£o, volta para estado zerado
        if (typeof setZeroState === 'function') setZeroState();
    });

    socket.on('connect_error', (error) => {
        console.error('‚úó Erro de conex√£o:', error);
    });

    // Elementos
    const tempEl = document.getElementById("temp");
    const luxEl = document.getElementById("lux");
    const posturaEl = document.getElementById("postura");
    const alertaTexto = document.getElementById("alertaTexto");
    const inclinacaoEl = document.getElementById("inclinacao");
    const cadeiraVisual = document.getElementById("cadeiraVisual");
    const anguloTexto = document.getElementById("anguloTexto");

    // Controle de "sem dados"
    let lastUpdate = 0;
    let noDataShown = false;

    function setZeroState() {
        // Reseta textos
        tempEl.innerText = '0 ¬∞C';
        luxEl.innerText = '0';
        posturaEl.innerText = 'Boa';
        inclinacaoEl.innerText = '0¬∞';
        alertaTexto.innerText = '‚úì Postura correta';
        alertaTexto.style.color = 'lightgreen';

        // Reseta cadeira
        atualizarCadeira(0);

        // Limpa gr√°ficos e mant√©m buffers pequenos
        labels.length = 0;
        tempData.length = 0;
        luxData.length = 0;
        
        chartTemp.data.labels = labels;
        chartTemp.data.datasets[0].data = tempData;
        chartTemp.update('none');

        chartLux.data.labels = labels;
        chartLux.data.datasets[0].data = luxData;
        chartLux.update('none');

        noDataShown = true;
        console.log('‚Ñπ Estado zerado exibido (sem dados).');
    }

    // Verifica periodicamente se estamos sem dados (5s sem atualiza√ß√£o)
    setInterval(() => {
        const now = Date.now();
        if (lastUpdate === 0) return; // ainda n√£o recebemos nenhum dado
        if (!noDataShown && now - lastUpdate > 5000) {
            console.log('‚è≥ 5s sem dados: aplicando estado zerado.');
            setZeroState();
        }
    }, 1000);

    // ================================
    //   BUFFER PARA OS GR√ÅFICOS
    // ================================
    const maxPoints = 30;
    let labels = [];

    let tempData = [];
    let luxData = [];

    // ================================
    //     GR√ÅFICO TEMPERATURA
    // ================================
    const chartTemp = new Chart(document.getElementById("grafTemp"), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Temperatura (¬∞C)",
                data: tempData,
                borderColor: '#ff6384',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 4,
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#ff6384',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.5,
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#fff'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#fff',
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#fff',
                        font: {
                            size: 14
                        }
                    }
                }
            }
        }
    });

    // ================================
    //     GR√ÅFICO LUMINOSIDADE
    // ================================
    const chartLux = new Chart(document.getElementById("grafLux"), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Luminosidade (LUX)",
                data: luxData,
                borderColor: '#ffcd56',
                backgroundColor: 'rgba(255, 205, 86, 0.1)',
                borderWidth: 4,
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#ffcd56',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.5,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#fff'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#fff',
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#fff',
                        font: {
                            size: 14
                        }
                    }
                }
            }
        }
    });

    // ================================
    //   FUN√á√ÉO ATUALIZAR CADEIRA
    // ================================
    function atualizarCadeira(angulo) {
        console.log("üîß Fun√ß√£o atualizarCadeira chamada com:", angulo);
        
        // Converte para n√∫mero
        const anguloNum = Number(angulo) || 0;
        console.log("üî¢ √Çngulo convertido para n√∫mero:", anguloNum);
        
        // Limita o √¢ngulo entre -45 e 45 graus
        const anguloLimitado = Math.max(-45, Math.min(45, anguloNum));
        console.log("üìê √Çngulo limitado:", anguloLimitado);
        
        // Aplica a rota√ß√£o na cadeira
        const transformValue = `rotate(${anguloLimitado}deg)`;
        console.log("üîÑ Aplicando transform:", transformValue);
        cadeiraVisual.style.transform = transformValue;
        
        // Atualiza o texto do √¢ngulo
        anguloTexto.textContent = `${anguloNum}¬∞`;
        
        // Muda a cor baseado na inclina√ß√£o
        if (Math.abs(anguloNum) > 30) {
            anguloTexto.style.color = '#ff6384'; // Vermelho - inclina√ß√£o perigosa
        } else if (Math.abs(anguloNum) > 15) {
            anguloTexto.style.color = '#ffcd56'; // Amarelo - aten√ß√£o
        } else {
            anguloTexto.style.color = '#4bc0c0'; // Verde - OK
        }
        
        console.log("‚úÖ Cadeira atualizada com sucesso!");
    }

    // ================================
    //   FUN√á√ÉO DE TESTE
    // ================================
    let anguloTeste = 0;
    function testarInclinacao() {
        anguloTeste += 10;
        if (anguloTeste > 45) anguloTeste = -45;
        
        console.log("üß™ TESTE MANUAL: Inclinando para", anguloTeste, "¬∞");
        
        // Atualiza o card
        inclinacaoEl.innerText = anguloTeste + "¬∞";
        
        // Atualiza a cadeira
        atualizarCadeira(anguloTeste);
    }

    // ==================================
    //   RECEBENDO DADOS DO PYTHON
    // ==================================
    socket.on("novo_dado", (d) => {
        console.log("üì• Dados recebidos:", d);
        console.log("ü™ë Inclina√ß√£o recebida:", d.inclinacao);
        console.log("ü™ë Tipo de inclina√ß√£o:", typeof d.inclinacao);

        // Marca atualiza√ß√£o
        lastUpdate = Date.now();
        noDataShown = false;

        tempEl.innerText = d.temp + " ¬∞C";
        luxEl.innerText = d.lux;
        posturaEl.innerText = d.postura === 1 ? "Ruim" : "Boa";
        
        // Garante que inclinacao seja um n√∫mero
        const inclinacao = d.inclinacao !== undefined && d.inclinacao !== null ? Number(d.inclinacao) : 0;
        console.log("üî¢ Inclina√ß√£o ap√≥s convers√£o:", inclinacao);
        
        inclinacaoEl.innerText = inclinacao + "¬∞";
        console.log("üìù Card de inclina√ß√£o atualizado para:", inclinacaoEl.innerText);

        alertaTexto.innerText = d.postura === 1 ? "‚ö† Postura incorreta!" : "‚úì Postura correta";
        alertaTexto.style.color = d.postura === 1 ? "red" : "lightgreen";

        // Atualiza a visualiza√ß√£o da cadeira
        console.log("üîÑ Chamando atualizarCadeira com:", inclinacao);
        atualizarCadeira(inclinacao);

        // timestamp
        const now = new Date().toLocaleTimeString();
        labels.push(now);
        if (labels.length > maxPoints) labels.shift();

        tempData.push(d.temp);
        if (tempData.length > maxPoints) tempData.shift();

        luxData.push(d.lux);
        if (luxData.length > maxPoints) luxData.shift();

        // Atualiza os gr√°ficos
        chartTemp.data.labels = labels;
        chartTemp.data.datasets[0].data = tempData;
        chartTemp.update('none');

        chartLux.data.labels = labels;
        chartLux.data.datasets[0].data = luxData;
        chartLux.update('none');

        console.log("üìä Gr√°ficos e cadeira atualizados!");
    });
</script>

</body>
</html>
